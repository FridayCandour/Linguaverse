<!-- explorer -->

<style>
  .chat-form {
    display: flex;
    border: 3px #f5f5f5 solid;
    border-radius: 12px;
    max-height: 48px;
    min-width: 360px;
    max-width: 540px;
    width: 90%;
    margin: 2rem auto 0px;
  }
  .chat-form input {
    border: none;
    outline: none;
    padding: 4px;
    border-radius: 6px;
    height: 100% !important;
    min-height: 42px;
    padding-left: 1rem;
    width: 96%;
  }
  .chat-form button {
    background-color: #e2e3e8;
    color: #fff;
    padding: 5px 16px;
    min-width: 2rem;
    border: none;
    border-radius: 12px;
    cursor: pointer;
  }
  .chat-form button:hover {
    background-color: #444;
  }
  .svg {
    width: var(--fa-fw-width, 1.25em);
    vertical-align: -0.25em;
    text-align: center;
  }
</style>

<div id="chat" class="page">
  <div class="chat-container">
    <ul id="chat-history">
      <div class="empty" id="empty">
        <h3>How can I assist you today?</h3>
      </div>
      <div class="loader" id="loader"></div>
    </ul>
  </div>
  <!--  -->
  <form id="chat-form" class="chat-form" onsubmit="return fromC(e)">
    <input type="text" id="user-message" placeholder="Ask me anything..." />
    <button class="btn-flat" onclick="fromC()">
      <svg
        aria-hidden="true"
        focusable="false"
        data-prefix="fas"
        data-icon="paper-plane"
        role="img"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 512 512"
        class="svg"
      >
        <path
          fill="white"
          d="M498.1 5.6c10.1 7 15.4 19.1 13.5 31.2l-64 416c-1.5 9.7-7.4 18.2-16 23s-18.9 5.4-28 1.6L284 427.7l-68.5 74.1c-8.9 9.7-22.9 12.9-35.2 8.1S160 493.2 160 480V396.4c0-4 1.5-7.8 4.2-10.7L331.8 202.8c5.8-6.3 5.6-16-.4-22s-15.7-6.4-22-.7L106 360.8 17.7 316.6C7.1 311.3 .3 300.7 0 288.9s5.9-22.8 16.1-28.7l448-256c10.7-6.1 23.9-5.5 34 1.4z"
        ></path>
      </svg>
    </button>
  </form>
</div>

<script>
  const generate = async ({ text, lang }) => {
    try {
      const cs = new AbortController();
      const to = setTimeout(() => {
        cs.abort();
      }, 2 * 60 * 1000);
      const res = await fetch(
        "https://linguaverse-api.uiedbook.workers.dev/chat",
        {
          headers: { "Content-Type": "application/json" },
          signal: cs.signal,
          body: JSON.stringify({
            message: text,
            lang,
          }),
          method: "POST",
        }
      );
      clearTimeout(to);
      const out = await res.json();

      if (!out.ok) {
        if (res.status !== 400) {
          document.getElementById("words").style.display = "flex";
          document.getElementById("login-loader").style.display = "none";
          document.getElementById("login").style.display = "block";
        } else {
          msgboxNoClose.show(
            "An error happened. Please try again!",
            null,
            "OK"
          );
        }
      }
      return {
        image:
          out.message?.endsWith(".jpg") || out.message?.endsWith(".png")
            ? out.message
            : "",
        text: !(out.message?.endsWith(".jpg") || out.message?.endsWith(".png"))
          ? out.message
          : "",
      };
    } catch (error) {
      console.log(error);
      msgboxNoClose.show("An error happened. Please try again!", null, "OK");
      return {
        text: "An error happened. Please try again!",
      };
    }
  };

  const addUserMSG = ({ text }) => {
    console.log({ text });
    const history = document.getElementById("chat-history");
    const empty = document.getElementById("empty");
    if (empty) {
      empty.remove();
    }
    const msg = li(
      { className: "user-message" },
      div(
        { className: "user" },
        img({
          src: "./assets/user.png",
          alt: "AI",
          className: "chatter",
        }),
        span("You")
      ),
      div(
        { className: "msg" },
        $if(text, () => p(text)),
        $if(image, () =>
          img({
            src: image,
            alt: "image prompt",
            onerror() {
              // this.src = image;
            },
          })
        )
      )
    );
    history.appendChild(msg);
    msg.scrollIntoView({ behavior: "smooth", block: "start" });
    addAIMSG({ text, image, model: model.toLowerCase() });
  };
  const addAIMSG = async ({ image, text, model }) => {
    const history = document.getElementById("chat-history");
    // show loader
    const loader = document.getElementById("loader");
    loader.style.display = "inline-grid";
    history.appendChild(loader);
    loader.scrollIntoView({ behavior: "smooth", block: "start" });
    let data = generate({ text, model });

    // call api
    const msg = ({ image, text }) =>
      li(
        { className: "ai-message" },
        div(
          { className: "user" },
          img({
            src: "./assets/apple-touch-icon.png",
            alt: "AI",
            className: "chatter",
          }),
          span("Browser AI")
        ),
        div(
          { className: "msg" },
          $if(text, () => p(text)),
          $if(!text && !image, () => p("An error happened. Please try again!")),
          $if(image, () =>
            img({
              src: image,
              alt: "image prompt",
              onerror() {
                this.src = image;
              },
            })
          )
        )
      );
    // console.log({ data, model, text, image });
    document.getElementById("loader").style.display = "none";
    const msgHtml = msg(data);
    history.appendChild(msgHtml);
    msgHtml.scrollIntoView({ behavior: "smooth", block: "start" });
  };

  const fromC = (e) => {
    e.preventDefault();
    const usersInput = document.getElementById("user-message");
    addUserMSG({
      text: usersInput.value,
    });
  };
</script>
